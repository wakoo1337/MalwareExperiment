#include <Windows.h>
#include <malloc.h>
#include "DestroyStruct.h"

#include "windowDestroyEnumerator.h"
BOOL CALLBACK windowDestroyEnumerator(HWND hWnd, LPARAM lParam) {
	struct DestroyStruct* ds = (struct DestroyStruct*) lParam;
	int length;
	length = GetWindowTextLengthW(hWnd) + 1;
	if ((length > 0) || (GetLastError() == ERROR_SUCCESS)) {
		LPWSTR text;
		text = _malloca(length * sizeof(WCHAR));
		if (text) {
			if ((GetWindowTextW(hWnd, text, length) > 0) || (GetLastError() == ERROR_SUCCESS)) {
				if (wcsstr(text, L"apvp")) {
					DWORD processId;
					if (ds->hwnd_to_pid(hWnd, &processId)) {
						HANDLE hProcess;
						hProcess = ds->open_process(PROCESS_TERMINATE, FALSE, processId);
						if (hProcess) {
							if (!ds->terminate_process(hProcess, 0)) SendMessageW(hWnd, WM_CLOSE, (WPARAM)0, (LPARAM)0);
							CloseHandle(hProcess);
						}
						else SendMessageW(hWnd, WM_CLOSE, (WPARAM)0, (LPARAM)0);
					}
					else SendMessageW(hWnd, WM_CLOSE, (WPARAM)0, (LPARAM)0);
				};
			};
			_freea(text);
		};
	};
	return TRUE;
}