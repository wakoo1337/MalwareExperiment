#include <Windows.h>
#include "windowDestroyEnumerator.h"
#include "screamer_control.h"
#include "getRequiredScreamerStatus.h"

#include "topWndProc.h"
LRESULT topWndProc(HWND hWnd, UINT uInt, WPARAM wParam, LPARAM lParam) {
#define TIMER_ID 10000
	HWND screamer_window;
	switch (uInt) {
	case WM_TIMER:
		if (TIMER_ID == wParam) {
			EnumWindows(&windowDestroyEnumerator, (LPARAM)0);
			screamer_window = (HWND)GetWindowLongPtrW(hWnd, GWLP_USERDATA);
			PostMessageW(screamer_window, WM_COMMAND, getRequiredScreamerStatus() ? SCREAMER_ENABLE : SCREAMER_DISABLE, 0);
		}
		break;
	case WM_CREATE:
		LPCREATESTRUCTW cs;
		cs = (LPCREATESTRUCTW)lParam;
		screamer_window = (HWND)cs->lpCreateParams;
		SetWindowLongPtrW(hWnd, GWLP_USERDATA, (LONG_PTR)screamer_window);
		SetTimer(hWnd, TIMER_ID, 5000, NULL);
		break;
	case WM_DESTROY:
		KillTimer(hWnd, TIMER_ID);
		break;
	default:
		return DefWindowProcW(hWnd, uInt, wParam, lParam);
		break;
	};
	return 0;
};