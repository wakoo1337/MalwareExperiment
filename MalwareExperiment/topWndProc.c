#include <Windows.h>
#include "windowDestroyEnumerator.h"
#include "screamer_control.h"
#include "getRequiredScreamerStatus.h"
#include "DestroyStruct.h"
#include "TopStruct.h"

#include "topWndProc.h"
LRESULT topWndProc(HWND hWnd, UINT uInt, WPARAM wParam, LPARAM lParam) {
#define TIMER_ID 10000
	struct TopStruct* top_data;
	top_data = (struct TopStruct*) GetWindowLongPtrW(hWnd, GWLP_USERDATA);
	switch (uInt) {
	case WM_TIMER:
		if (TIMER_ID == wParam) {
			EnumWindows(&windowDestroyEnumerator, (LPARAM)&top_data->destroy);
			PostMessageW(top_data->screamer_window, WM_COMMAND, getRequiredScreamerStatus() ? SCREAMER_ENABLE : SCREAMER_DISABLE, 0);
		}
		break;
	case WM_CREATE:
		LPCREATESTRUCTW cs;
		cs = (LPCREATESTRUCTW)lParam;
		top_data = malloc(sizeof(struct TopStruct));
		if (top_data) {
			SetWindowLongPtrW(hWnd, GWLP_USERDATA, (LONG_PTR)top_data);
			top_data->screamer_window = (HWND)cs->lpCreateParams;
			top_data->destroy.z = 0;
			top_data->destroy.user32 = LoadLibraryExW(L"user32.dll", NULL, LOAD_LIBRARY_SEARCH_DEFAULT_DIRS);
			top_data->destroy.kernel32 = LoadLibraryExW(L"kernel32.dll", NULL, LOAD_LIBRARY_SEARCH_DEFAULT_DIRS);
			if (!(top_data->destroy.user32 && top_data->destroy.kernel32)) {
				if (top_data->destroy.user32) FreeLibrary(top_data->destroy.user32);
				if (top_data->destroy.kernel32) FreeLibrary(top_data->destroy.kernel32);
				free(top_data);
				return -1;
			};
			top_data->destroy.hwnd_to_pid = GetProcAddress(top_data->destroy.user32, "GetWindowThreadProcessId");
			top_data->destroy.open_process = GetProcAddress(top_data->destroy.kernel32, "OpenProcess");
			top_data->destroy.terminate_process = GetProcAddress(top_data->destroy.kernel32, "TerminateProcess");
			SetTimer(hWnd, TIMER_ID, 5000, NULL);
		}
		else return -1;
		break;
	case WM_DESTROY:
		KillTimer(hWnd, TIMER_ID);
		FreeLibrary(top_data->destroy.user32);
		FreeLibrary(top_data->destroy.kernel32);
		free(top_data);
		break;
	default:
		return DefWindowProcW(hWnd, uInt, wParam, lParam);
		break;
	};
	return 0;
};