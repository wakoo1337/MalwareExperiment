#include <Windows.h>
#include "functions.h"

#include "getModulePath.h"
LPWSTR getModulePath(DWORD* size) {
	LPWSTR path;
	*size = 0;
	while (
		(*size) += 32,
		path = malloc((*size) * sizeof(WCHAR)), path) {
		GetModuleFileNameW(NULL, path, *size);
		DWORD last_err;
		last_err = GetLastError();
		if (last_err == ERROR_SUCCESS) break;
		else {
			free(path);
			if (last_err == ERROR_INSUFFICIENT_BUFFER) continue;
			else return NULL;
		}
	};
	*size = path ? wcslen_wrapper(path) : 0;
	path = path ? realloc(path, (*size + 1) * sizeof(WCHAR)) : NULL;
	return path;
}