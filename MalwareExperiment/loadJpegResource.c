#include <Windows.h>
#include <wincodec.h>

#include "loadJpegResource.h"
LPBYTE loadJpegResource(IWICImagingFactory* factory, int res_id, BITMAPINFOHEADER* info_hdr) {
	HBITMAP ret = NULL;
	HRSRC resource;
	resource = FindResourceW(NULL, MAKEINTRESOURCEW(res_id), L"IMAGE");
	if (resource) {
		HGLOBAL resource_handle;
		resource_handle = LoadResource(NULL, resource);
		if (resource_handle) {
			LPVOID jpeg_data;
			DWORD jpeg_length;
			jpeg_data = LockResource(resource_handle);
			if (jpeg_data) {
				jpeg_length = SizeofResource(NULL, resource);
				IWICStream* stream;
				if (SUCCEEDED(factory->lpVtbl->CreateStream(factory, &stream))) {
					if (SUCCEEDED(stream->lpVtbl->InitializeFromMemory(stream, jpeg_data, jpeg_length))) {
						IWICBitmapDecoder* decoder;
						IStream* istream;
						if (SUCCEEDED(stream->lpVtbl->QueryInterface(stream, &IID_IStream, &istream))) {
							if (SUCCEEDED(factory->lpVtbl->CreateDecoderFromStream(factory, istream, NULL, WICDecodeMetadataCacheOnLoad, &decoder))) {
								IWICBitmapFrameDecode* decode;
								if (SUCCEEDED(decoder->lpVtbl->GetFrame(decoder, 0, &decode))) {
									IWICFormatConverter* converter;
									if (SUCCEEDED(factory->lpVtbl->CreateFormatConverter(factory, &converter))) {
										IWICBitmapSource* bmp_source;
										if (SUCCEEDED(decode->lpVtbl->QueryInterface(decode, &IID_IWICBitmapSource, &bmp_source))) {
											if (SUCCEEDED(converter->lpVtbl->Initialize(converter, bmp_source, &GUID_WICPixelFormat24bppBGR, WICBitmapDitherTypeNone, NULL, 0.0f, WICBitmapPaletteTypeCustom))) {
												UINT width, height, img_size;
												converter->lpVtbl->GetSize(converter, &width, &height);
												img_size = 3 * width * height;
												LPBYTE bits;
												bits = malloc(img_size);
												if (bits) {
													WICRect rect;
													rect.X = 0;
													rect.Y = 0;
													rect.Width = width;
													rect.Height = height;
													if (SUCCEEDED(converter->lpVtbl->CopyPixels(converter, &rect, 3 * width, img_size, bits))) {
														*info_hdr = (BITMAPINFOHEADER){ 0 };
														info_hdr->biSize = sizeof(BITMAPINFOHEADER);
														info_hdr->biWidth = width;
														info_hdr->biHeight -= height;
														info_hdr->biPlanes = 1;
														info_hdr->biBitCount = 24;
														info_hdr->biCompression = BI_RGB;
														info_hdr->biSizeImage = img_size;
														bmp_source->lpVtbl->Release(bmp_source);
														converter->lpVtbl->Release(converter);
														decode->lpVtbl->Release(decode);
														decoder->lpVtbl->Release(decoder);
														istream->lpVtbl->Release(istream);
														stream->lpVtbl->Release(stream);
														return bits;
													}
													else {
														free(bits);
														bmp_source->lpVtbl->Release(bmp_source);
														converter->lpVtbl->Release(converter);
														decode->lpVtbl->Release(decode);
														decoder->lpVtbl->Release(decoder);
														istream->lpVtbl->Release(istream);
														stream->lpVtbl->Release(stream);
														return NULL;
													};
												};
											};
											bmp_source->lpVtbl->Release(bmp_source);
										};
										converter->lpVtbl->Release(converter);
									};
									decode->lpVtbl->Release(decode);
								};
								decoder->lpVtbl->Release(decoder);
							};
							istream->lpVtbl->Release(istream);
						};
					};
					stream->lpVtbl->Release(stream);
				};
			};
		};
	};
	return NULL;
}