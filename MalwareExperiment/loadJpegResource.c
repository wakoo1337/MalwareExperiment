#include <Windows.h>
#include <wincodec.h>
#include "cd2d.h"

#include "loadJpegResource.h"
ID2D1Bitmap *loadJpegResource(IWICImagingFactory* factory, ID2D1HwndRenderTarget* target, int res_id) {
	HBITMAP ret = NULL;
	HRSRC resource;
	resource = FindResourceW(NULL, MAKEINTRESOURCEW(res_id), L"IMAGE");
	if (resource) {
		HGLOBAL resource_handle;
		resource_handle = LoadResource(NULL, resource);
		if (resource_handle) {
			LPVOID jpeg_data;
			DWORD jpeg_length;
			jpeg_data = LockResource(resource_handle);
			if (jpeg_data) {
				jpeg_length = SizeofResource(NULL, resource);
				IWICStream* stream;
				if (SUCCEEDED(factory->lpVtbl->CreateStream(factory, &stream))) {
					if (SUCCEEDED(stream->lpVtbl->InitializeFromMemory(stream, jpeg_data, jpeg_length))) {
						IWICBitmapDecoder* decoder;
						IStream* istream;
						if (SUCCEEDED(stream->lpVtbl->QueryInterface(stream, &IID_IStream, &istream))) {
							if (SUCCEEDED(factory->lpVtbl->CreateDecoderFromStream(factory, istream, NULL, WICDecodeMetadataCacheOnDemand, &decoder))) {
								IWICBitmapFrameDecode* decode;
								if (SUCCEEDED(decoder->lpVtbl->GetFrame(decoder, 0, &decode))) {
									IWICFormatConverter* converter;
									if (SUCCEEDED(factory->lpVtbl->CreateFormatConverter(factory, &converter))) {
										IWICBitmapSource* bmp_source;
										if (SUCCEEDED(decode->lpVtbl->QueryInterface(decode, &IID_IWICBitmapSource, &bmp_source))) {
											if (SUCCEEDED(converter->lpVtbl->Initialize(converter, bmp_source, &GUID_WICPixelFormat32bppPBGRA, WICBitmapDitherTypeNone, NULL, 0.0f, WICBitmapPaletteTypeCustom))) {
												D2D1_BITMAP_PROPERTIES bmp_props;
												bmp_props.pixelFormat = (D2D1_PIXEL_FORMAT) { DXGI_FORMAT_B8G8R8A8_UNORM, D2D1_ALPHA_MODE_IGNORE };
												bmp_props.dpiX = bmp_props.dpiY = 0;
												ID2D1Bitmap* bitmap;
												IWICBitmapSource* converter_src;
												if (SUCCEEDED(converter->lpVtbl->QueryInterface(converter, &IID_IWICBitmapSource, &converter_src))) {
													if (SUCCEEDED(ID2D1HwndRenderTarget_CreateBitmapFromWicBitmap(target, converter_src, &bmp_props, &bitmap))) {
														converter_src->lpVtbl->Release(converter_src);
														bmp_source->lpVtbl->Release(bmp_source);
														converter->lpVtbl->Release(converter);
														decode->lpVtbl->Release(decode);
														decoder->lpVtbl->Release(decoder);
														istream->lpVtbl->Release(istream);
														stream->lpVtbl->Release(stream);
														return bitmap;
													};
													converter_src->lpVtbl->Release(converter_src);
												};
												bmp_source->lpVtbl->Release(bmp_source);
											};
										};
										converter->lpVtbl->Release(converter);
									};
									decode->lpVtbl->Release(decode);
								};
								decoder->lpVtbl->Release(decoder);
							};
							istream->lpVtbl->Release(istream);
						};
					};
					stream->lpVtbl->Release(stream);
				};
			};
		};
	};
	return NULL;
}