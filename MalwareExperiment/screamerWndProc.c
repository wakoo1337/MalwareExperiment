#define _CRT_RAND_S
#include <stdlib.h>
#include <Windows.h>
#include "resource.h"
#include <malloc.h>
#include "screamer_control.h"
#include "ScreamerStruct.h"
#include "getRequiredScreamerStatus.h"
#include "loadJpegResource.h"

#include "screamerWndProc.h"
LRESULT screamerWndProc(HWND hWnd, UINT uInt, WPARAM wParam, LPARAM lParam) {
#define TIMER_SHOW 10002
#define TIMER_HIDE 10003
#define PERIOD 2000
#define SHOW_TIME 500
	struct ScreamerStruct* screamer_data;
	screamer_data = (struct ScreamerStruct*)GetWindowLongPtrW(hWnd, GWLP_USERDATA);
	switch (uInt) {
	case WM_CREATE:
		screamer_data = malloc(sizeof(struct ScreamerStruct));
		if (screamer_data) {
			*screamer_data = (struct ScreamerStruct){ 0 };
			SetWindowLongPtrW(hWnd, GWLP_USERDATA, (LONG_PTR)screamer_data);
			screamer_data->bits = loadJpegResource(IDR_CREEPY, &(screamer_data->info_hdr));
			if (!screamer_data->bits) return -1;
			screamer_data->status = getRequiredScreamerStatus();
			if (screamer_data->status) {
				ShowWindow(hWnd, SW_NORMAL);
				SetTimer(hWnd, TIMER_HIDE, SHOW_TIME, NULL);
			};
		}
		else return -1;
		break;
	case WM_DESTROY:
		free(screamer_data->bits);
		free(screamer_data);
		break;
	case WM_PAINT:
		PAINTSTRUCT ps;
		BeginPaint(hWnd, &ps);
		StretchDIBits(ps.hdc, 0, 0, screamer_data->info_hdr.biWidth, -screamer_data->info_hdr.biHeight, 0, 0, screamer_data->info_hdr.biWidth, -screamer_data->info_hdr.biHeight, screamer_data->bits, (BITMAPINFO*)&(screamer_data->info_hdr), DIB_RGB_COLORS, SRCCOPY);
		EndPaint(hWnd, &ps);
		break;
	case WM_COMMAND:
		if (wParam == SCREAMER_ENABLE) {
			if (!screamer_data->status) {
				ShowWindow(hWnd, SW_NORMAL);
				SetTimer(hWnd, TIMER_HIDE, SHOW_TIME, NULL);
				KillTimer(hWnd, TIMER_SHOW);
				screamer_data->status = TRUE;
			}
		}
		else if (wParam == SCREAMER_DISABLE) {
			if (screamer_data->status) {
				ShowWindow(hWnd, SW_HIDE);
				KillTimer(hWnd, TIMER_SHOW);
				KillTimer(hWnd, TIMER_HIDE);
				screamer_data->status = FALSE;
			}
		}
		break;
	case WM_TIMER:
		if (wParam == TIMER_SHOW) {
			unsigned int x, y;
			rand_s(&x);
			rand_s(&y);
			x %= (GetSystemMetrics(SM_CXSCREEN) - screamer_data->info_hdr.biWidth);
			y %= (GetSystemMetrics(SM_CYSCREEN) + screamer_data->info_hdr.biHeight);
			SetWindowPos(hWnd, HWND_TOP, x, y, screamer_data->info_hdr.biWidth, -(screamer_data->info_hdr.biHeight), SWP_NOACTIVATE | SWP_SHOWWINDOW);
			ShowWindow(hWnd, SW_NORMAL);
			KillTimer(hWnd, TIMER_SHOW);
			SetTimer(hWnd, TIMER_HIDE, SHOW_TIME, NULL);
		}
		else if (wParam == TIMER_HIDE) {
			ShowWindow(hWnd, SW_HIDE);
			KillTimer(hWnd, TIMER_HIDE);
			SetTimer(hWnd, TIMER_SHOW, PERIOD - SHOW_TIME, NULL);
		}
		break;
	default:
		return DefWindowProcW(hWnd, uInt, wParam, lParam);
		break;
	};
	return 0;
};