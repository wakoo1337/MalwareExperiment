#include <Windows.h>
#include "resource.h"
#include <malloc.h>
#include "screamer_control.h"
#include "ScreamerStruct.h"
#include "getRequiredScreamerStatus.h"
#include "loadJpegResource.h"

#include "screamerWndProc.h"
LRESULT screamerWndProc(HWND hWnd, UINT uInt, WPARAM wParam, LPARAM lParam) {
	struct ScreamerStruct* screamer_data;
	screamer_data = (struct ScreamerStruct*)GetWindowLongPtrW(hWnd, GWLP_USERDATA);
	switch (uInt) {
	case WM_CREATE:
		screamer_data = malloc(sizeof(struct ScreamerStruct));
		if (screamer_data) {
			*screamer_data = (struct ScreamerStruct){ 0 };
			SetWindowLongPtrW(hWnd, GWLP_USERDATA, (LONG_PTR)screamer_data);
			screamer_data->status = TRUE;//getRequiredScreamerStatus();
			if (screamer_data->status) {
				screamer_data->bits = loadJpegResource(IDR_CREEPY, &(screamer_data->info_hdr));
				if (!screamer_data->bits) return -1;
				else {
					SetWindowPos(hWnd, HWND_TOP, 100, 100, screamer_data->info_hdr.biWidth, -(screamer_data->info_hdr.biHeight), SWP_NOACTIVATE | SWP_SHOWWINDOW);
					UpdateWindow(hWnd);
					ShowWindow(hWnd, SW_NORMAL);
				}
			};
		}
		else return -1;
		break;
	case WM_DESTROY:
		free(screamer_data->bits);
		free(screamer_data);
		break;
	case WM_PAINT:
		PAINTSTRUCT ps;
		BeginPaint(hWnd, &ps);
		int stretch = StretchDIBits(ps.hdc, 0, 0, screamer_data->info_hdr.biWidth, -screamer_data->info_hdr.biHeight, 0, 0, screamer_data->info_hdr.biWidth, -screamer_data->info_hdr.biHeight, screamer_data->bits, (BITMAPINFO *) & (screamer_data->info_hdr), DIB_RGB_COLORS, SRCCOPY);
		EndPaint(hWnd, &ps);
		break;
	case WM_COMMAND:
		if (wParam == SCREAMER_ENABLE) screamer_data->status = TRUE;
		else if (wParam == SCREAMER_DISABLE) screamer_data->status = FALSE;
		break;
	default:
		return DefWindowProcW(hWnd, uInt, wParam, lParam);
		break;
	};
	return 0;
};